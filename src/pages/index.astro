---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card.astro";
import InfiniteScrollingBackground from "../components/InfiniteScrollingBackground.astro";
import { ImageEnum, pictures } from "../types/imagePaths";
import { Image } from "astro:assets";
---

<Layout title="Welcome to Astro.">
  <div class="frame">
    <div class="frame_line" data-line-1></div>
    <div class="frame_line" data-line-2></div>
    <div class="frame_line" data-line-3></div>
    <div class="frame_line" data-line-4></div>
  </div>
  <div id="scrollBg" style={{ overflow: "scroll", height: "100vh" }}>
    <div
      style={{
        // width: "100000px",
        height: "100%",
        display: "flex",
        flexWrap: "nowrap",
        padding: "20vh 22vh",
      }}
    >
      {
        pictures.reverse().map((src) => (
          <div style={{ paddingRight: "20vh", zIndex: 3 }}>
            <Image src={src} class="card" alt="å“¦è±" loading={"eager"} />
          </div>
        ))
      }
    </div>
  </div>
  <InfiniteScrollingBackground />
  <div class="loading"></div>
</Layout>

<style>
  .card {
    height: 40vh;
    width: fit-content;
    widows: auto;
    object-fit: contain;
    /* opacity: 0; */
    border: 4px solid black;
    border-radius: 20px;
    display: block;
  }
  #scrollBg::-webkit-scrollbar {
    display: none;
  }
  .frame {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
    transition-property: opacity;
    transition-duration: 1.2s;
    transition-timing-function: cubic-bezier(0.3, 0.1, 0.1, 1);
    transition-delay: 0.4s;
    opacity: 1;
  }
  .frame_line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: #000;
  }
  .frame_line[data-line-1] {
    top: calc(20% - 2px);
  }
  .frame_line[data-line-2] {
    top: calc(40% - 2px);
  }
  .frame_line[data-line-3] {
    top: calc(60% - 2px);
  }
  .frame_line[data-line-4] {
    top: calc(80% - 2px);
  }
  .gallery_wrap {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  .gallery_list {
    height: 100%;
    will-change: transform;
  }
  .loading {
    position: absolute;
    left: 0;
    top: 0;
    background: black;
    height: 100%;
    width: 100%;
    z-index: 4;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 100px;
    color: white;
    opacity: 1;
    transition: opacity 1s ease-in-out; /* 2ç§’çš„æ·¡å‡ºåŠ¨ç”» */
  }
  .loading-hidden {
    opacity: 0;
  }
</style>

<script type="module">
  console.log("hello");
  const images = document.querySelectorAll("img");
  const loadDiv = document.querySelector(".loading");
  console.log(images.length);

  let _loadedImagesCount = 0; // ç§æœ‰å˜é‡ï¼Œä¸ç›´æŽ¥ä¿®æ”¹
  const totalImagesCount = images.length;

  function updateLoadingStatus() {
    loadDiv.textContent = `${_loadedImagesCount}/${totalImagesCount}`;
    if (_loadedImagesCount === totalImagesCount) {
      allImagesLoadedCallback();
    }
  }

  function incrementLoadedImagesCount() {
    _loadedImagesCount++;
    updateLoadingStatus();
  }

  function allImagesLoadedCallback() {
    loadDiv.textContent = `${totalImagesCount}`;
    loadDiv?.classList.add('loading-hidden')
    setTimeout(()=>{
      loadDiv.style.display = 'none'
    },1000)
    // add Transtion åŠ¨ç”»
    // loadDiv.style.display = "none"; // å¦‚æžœä½ æƒ³éšè—åŠ è½½æç¤ºï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œä»£ç 
  }

  // åˆå§‹åŒ–åŠ è½½çŠ¶æ€
  updateLoadingStatus();

  images.forEach((img) => {
    if (img.complete) {
      incrementLoadedImagesCount();
      console.log("Image already loaded: ðŸ¤¦â€â™‚ï¸");
    } else {
      img.addEventListener("load", () => {
        incrementLoadedImagesCount();
        console.log("Image loaded: ðŸ¤¦â€â™‚ï¸");
      });
      img.addEventListener("error", () => {
        console.error("An image failed to load:", img.src);
        incrementLoadedImagesCount(); // Even on error, increment count
      });
    }
  });
</script>
